import com.rameses.annotations.*;

class StudentApplicantService {

	@PersistenceContext("main")
	def em;
	
	@Service("DateService")
	def dateSvc;

	@Service("UserAccountService")
	def userSvc;
	
	@Service( "DocnoGeneratorService" )
	def generator;
	
	@ProxyMethod
	public def submit(def o) {
		def df = new java.text.SimpleDateFormat( "yyyy" );
		def pfx = "S"+df.format(new Date());
		o.objid = generator.getNextNumber([name:"student_applicant", prefix: pfx ]);
		return em.create( "student:applicant", o );
	}
	
	@ProxyMethod
	public def accept(def o) {
		def m = [:];
		m.putAll( o );
		m.objid = "STUD" + new java.rmi.server.UID();
		m.appno = o.objid;
		em.create( "student", m );
		em.delete( "student:applicant", o );
		
		//also create a login automatically
		def u = [:];
		u.objid = m.objid;
		u.usertype = "student";
		u.firstname = m.firstname;
		u.lastname = m.lastname;
		u.uid = m.studentno;
		u.pwd = "1234";
		u.email = m.email;
		userSvc.createLoginAccount( u );
	}
	
	@ProxyMethod
	public def read(def o) {
		o = em.read( "student:applicant", o );
		if(o.birthdate) o.birthdate = dateSvc.format( "yyyy-MM-dd", o.birthdate );
		return o;
	}
	
	@ProxyMethod
	public def getList(def params) {
		def qry = em.sqlContext.createNamedQuery( "student:list-applicants" );
		if(params) {
			if(params._start) qry.setFirstResult( params._start );
			if(params._limit) qry.setMaxResults( params._limit );
			qry.setParameters( params );
		}
		return qry.resultList;
	}
	
	
	

}